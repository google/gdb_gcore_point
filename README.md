# gcore_point

A GDB script that introduces a special breakpointing command to automatically generate core files upon the breakpoint being hit.

This script was inspired by a strange bug in production that only occurs occasionally in a particular spot in the callstack. With this script, you can use the `gcore-point` command to create a special breakpoint that will generate a
core file when hit. This allows you to leave the program running under the debugger for as long as is necessary, and you can individually inspect coredumps each time the potentially problematic operation occured.

## Usage

The code for the command is entirely self-contained in the `gcore_point.py` file. You can either clone this repo, or simply copy the contents of that file to your own `.py` file.  

Let's take this toy C program:
```c
#include <stdio.h>

int main() {
    for (int i=0; i<10; i++) {
        int a = i + 1;
        int b = i + 2;
        int c = i + 3;
        printf("%d + %d + %d = %d", a, b, c, a+b+c); // cheeky newline omission so the example output fits nice :)
    }
    return 0;
}
```
Build it with debug symbols:
```
gcc -g -o test_program main.c
```
Now load it up in `gdb`: 
```
gdb test_program
```
We'll `source` the Python script:
```
(gdb) source gcore_point.py 
```
A new command called `gcore-point` will now be accessible:
```
(gdb) help gcore-point
Generate a new breakpoint that will automatically generate a core file when hit.

Usage:
    gcore-point spec [, core name]

Arguments:
    spec: The breakpoint location specified in the usual breakpoint spec format.
    core name (optional): A set name to include as part of the generated core file name.
```
Let's set a `gcore-point` at the final line of the loop:
```
(gdb) gcore-point main.c:8 sum_loop_end
```
Now we can run the program:
```
(gdb) run
Starting program: /home/braydonk/Git/core_dump_breakpoint/test_program/test_program 
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Saved corefile core.sum_loop_end.1617338.0
Saved corefile core.sum_loop_end.1617338.1
Saved corefile core.sum_loop_end.1617338.2
Saved corefile core.sum_loop_end.1617338.3
Saved corefile core.sum_loop_end.1617338.4
Saved corefile core.sum_loop_end.1617338.5
Saved corefile core.sum_loop_end.1617338.6
Saved corefile core.sum_loop_end.1617338.7
Saved corefile core.sum_loop_end.1617338.8
Saved corefile core.sum_loop_end.1617338.9
1 + 2 + 3 = 62 + 3 + 4 = 93 + 4 + 5 = 124 + 5 + 6 = 155 + 6 + 7 = 186 + 7 + 8 = 217 + 8 + 9 = 248 + 9 + 10 = 279 + 10 + 11 = 3010 + 11 + 12 = 33[Inferior 1 (process 1617338) exited normally]
```
Now if we exit GDB we will see all the generated corefiles. If we want to see what the state of the program was the 5th time the breakpoint was hit, we can load up the core file ending in `.4`:
```
gdb test_program core.sum_loop_end.1617338.4
```
We can poke through the state of the program at the time similarly to if we were in a breakpoint:
```
Core was generated by `/home/braydonk/Git/core_dump_breakpoint/test_program/test_program'.
Program terminated with signal SIGTRAP, Trace/breakpoint trap.
#0  main () at main.c:8
8	        printf("%d + %d + %d = %d", a, b, c, a+b+c);
(gdb) print i
$1 = 4
(gdb) print a
$2 = 5
(gdb) print b
$3 = 6
(gdb) print c
$4 = 7
```

## How It Works

This script uses the [`gdb` Python Breakpoint API](https://sourceware.org/gdb/current/onlinedocs/gdb.html/Breakpoints-In-Python.html) to register a breakpoint that will execute `gdb`'s `gcore` command at the specified location. 

The `gcore` command in `gdb` is special because it requires the inferior to accept a `ptrace` request with a `PTRACE_GETREGS` operation. The initial version of this script naively executed `gcore` directly within the `stop` method of the custom breakpoint, however this did not work because `gdb` evaluates breakpoints before actually stopping the inferior. As a result, I had to get creative to make sure the `gcore` command can run only after the inferior is stopped. 

This is where the [`gdb` Python Events API](https://sourceware.org/gdb/current/onlinedocs/gdb.html/Events-In-Python.html) comes in. This allows us to register an object that will be notified of various types of `gdb` events. The script implements a custom one-shot event object which registers itself to a given event, and disconnects itself immediately after running once. The breakpoint registers a one-shot event that calls `gcore` and registers itself to the `stop` events registry, and then tells `gdb` to stop the inferior. Once the inferior is stopped, the `gcore` command will run, and execution of `gdb` will continue.
